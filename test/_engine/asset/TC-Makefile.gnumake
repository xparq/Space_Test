# BEWARE: GNUMake doesn't seem to support quoting target names with spaces, so:
# https://stackoverflow.com/a/10571900/1479945
 Space = $(subst ,, )
eSpace = $(subst ,,\ )

_BASENAME_W_SPACES_ESCAPED = $(subst $(Space),$(eSpace),$(CASE))
# Note: would still fail on any other whitespace, of course...

# Only a single same-name .cpp is supported for now:
SRC = $(_BASENAME_W_SPACES_ESCAPED).cpp

ifeq "$(OS)" "Windows_NT"
EXE = $(CASE).exe
EXE_W_SPACES_ESCAPED = $(_BASENAME_W_SPACES_ESCAPED).exe
else
EXE = $(CASE)
EXE_W_SPACES_ESCAPED = $(_BASENAME_W_SPACES_ESCAPED)
endif


#!!If no BUILD_DEPS_COMMON then TEST_DIR/ would break, but fortunately
#!!TEST_DIR/. won't... Ehh... But then again, the test dir would most likely
#!!be more up-to-date than the TC target, always triggering a build...
#!!Also...: GNU make is evil enough to include stray leading spaces in the
#!!*filename* itself, instead of expandingf it onto the dependency line
#!!itself below, so just adding an empty common dep (separated with a space)
#!!would ALSO FAIL (unlike in NMAKE)... :-o
ifeq ($(BUILD_DEPS_COMMON),)
deps = $(SRC)
else
deps = $(TEST_DIR)/$(BUILD_DEPS_COMMON) $(SRC)
endif


# (The "real" $(SHELL) is no good on Windows, even if set!)
ifeq "$(_SH_)" ""
_SH_ = sh
endif
ifeq "$(_SH_)" "/" #!! Workaround until #90 is fixed!
_SH_ = sh
endif

GENERIC_BUILD_CMD=$(_SH_) -c '. build.sh' dummy-1st-arg-will-be-ignored

$(EXE_W_SPACES_ESCAPED): $(deps)
	$(GENERIC_BUILD_CMD) "$(CASE)" "$(EXE)"
#!!NOT:	$(GENERIC_BUILD_CMD) "$(CASE)" "$@" # $@ gets unescaped here; but GNUMake still fucks up the quoting! :-o
#!!NOT:	$(GENERIC_BUILD_CMD) "$(CASE)" "$(EXE_NAME_W_SPACES_ESCAPED)"
#	echo "PATH=$(PATH)"
#	echo "GENERIC_BUILD_CMD = $(GENERIC_BUILD_CMD)"
